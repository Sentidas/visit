name: Build Country Service

on:
  push:
    branches: [main]

env:
  IMAGE_TAG: sentidas1/country-service:${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Получение кода
      - uses: actions/checkout@v4

      # Установка Java
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Права для gradlew
      - run: chmod +x gradlew

      # Сборка JAR
      - run: ./gradlew :country:clean :country:build

      # Сборка Docker образа
      - run: docker build -t ${{ env.IMAGE_TAG }} -f country/Dockerfile .

      # Создание override файла
      - run: |
          cat > docker-compose.override.yml << EOF
          services:
            country-app:
              image: ${{ env.IMAGE_TAG }}
          EOF

      # Тестирование с проверками
      - name: Test with Docker Compose
        run: |
          docker compose up -d
          sleep 40
          
          # Проверка БД
          if ! docker exec country-db mysqladmin ping -h localhost -u root -proot; then
            echo "Database health check failed"
            docker compose logs
            exit 1
          fi
          
          # Проверка приложения
          if ! curl -f http://localhost:8088/actuator/health; then
            echo "Application health check failed"
            docker compose logs
            exit 1
          fi
          
          docker compose down

      # Публикация в Docker Hub
      - name: Push to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push ${{ env.IMAGE_TAG }}
          docker tag ${{ env.IMAGE_TAG }} sentidas1/country-service:latest
          docker push sentidas1/country-service:latest

      # Обновление Kubernetes манифестов
      - name: Update Kubernetes manifests
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          sed -i "s|image: sentidas1/country-service:.*|image: ${{ env.IMAGE_TAG }}|g" k8s/deployment.yaml
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add k8s/deployment.yaml
          git commit -m "Deploy version ${{ github.sha }}"
          git push